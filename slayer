#!/bin/bash

# SLAYER - Simple wrapper for enterprise load testing
# Usage: ./slayer <url> [options]

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
BOLD='\033[1m'
NC='\033[0m'

# Banner simple
show_banner() {
    echo -e "${WHITE}${BOLD}"
    echo "╔══════════════════════════════════════════╗"
    echo "║                 SLAYER                   ║"
    echo "╚══════════════════════════════════════════╝"
    echo -e "${NC}"
    echo -e "${CYAN}Advanced HTTP Load Testing Tool${NC}"
    echo
}

# Ayuda
show_help() {
    echo -e "${CYAN}SLAYER Enterprise Load Testing Tool${NC}"
    echo "=" * 45
    echo ""
    echo -e "${YELLOW}USAGE:${NC}"
    echo "  $0 <url>                 - Quick test (50 RPS, 60s)"
    echo "  $0 <url> -r <rps>        - Set custom RPS"
    echo "  $0 <url> -t <time>s      - Run for specific time"
    echo "  $0 <url> --threads <n>   - Set concurrent threads"
    echo "  $0 <url> --method <GET|POST|PUT|DELETE> - Set HTTP method"
    echo ""
    echo -e "${YELLOW}OPTIONS:${NC}"
    echo "  -r, --rps <num>          - Requests per second (default: 50)"
    echo "  -t, --time <seconds>s    - Test duration"
    echo "  --threads <num>          - Concurrent connections (default: 10)"
    echo "  --method <method>        - HTTP method (default: GET)"
    echo "  --pattern <type>         - Traffic pattern (constant, ramp_up, burst)"
    echo "  --dashboard              - Enable web dashboard"
    echo "  --config <file>          - Load from config file"
    echo ""
    echo -e "${YELLOW}EXAMPLES:${NC}"
    echo "  $0 https://httpbin.org/get"
    echo "  $0 https://api.example.com -r 100 -t 120s"
    echo "  $0 https://api.example.com --threads 20 --dashboard"
    echo "  $0 https://api.example.com --method POST"
    echo ""
    echo -e "${YELLOW}QUICK COMMANDS:${NC}"
    echo "  dashboard                - Open dashboard only"
    echo "  config                   - Generate config template"
}

# Verificar dependencias básicas
check_dependencies() {
    if ! command -v python3 &> /dev/null; then
        echo -e "${RED}[!] Error: python3 not found${NC}" >&2
        exit 1
    fi
    
    if [ ! -f "slayer_enterprise_enhanced.py" ]; then
        echo -e "${RED}[!] Error: slayer_enterprise_enhanced.py not found${NC}" >&2
        exit 1
    fi
}

# Función principal
main() {
    # Verificar dependencias
    check_dependencies > /dev/null 2>&1
    
    # Mostrar ayuda si no hay argumentos
    if [ $# -eq 0 ]; then
        clear
        show_banner
        show_help
        exit 0
    fi
    
    # Help command
    if [ "$1" = "help" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        show_help
        exit 0
    fi
    
    # Comandos especiales
    case $1 in
        "dashboard")
            echo -e "${CYAN}[+] Opening dashboard at http://localhost:8080${NC}"
            python3 slayer_enterprise_enhanced.py load-test \
                --url http://httpbin.org/get \
                --rps 1 \
                --duration 5 \
                --dashboard
            ;;
            
        "config")
            echo -e "${CYAN}[+] Generating config template...${NC}"
            python3 slayer_enterprise_enhanced.py generate-config --output slayer_config.json
            echo -e "${GREEN}Config template saved: slayer_config.json${NC}"
            ;;
            
        *)
            # Tratar primer argumento como URL
            if [[ "$1" =~ ^https?:// ]]; then
                url="$1"
                shift
                
                # Construir argumentos
                args=("--url" "$url")
                
                # Parse argumentos
                while [ $# -gt 0 ]; do
                    case $1 in
                        "-r"|"--rps")
                            args+=("--rps" "$2")
                            shift 2
                            ;;
                        "-t"|"--time")
                            duration=${2%s}  # Remove 's' if present
                            args+=("--duration" "$duration")
                            shift 2
                            ;;
                        "--threads")
                            args+=("--threads" "$2")
                            shift 2
                            ;;
                        "--method")
                            args+=("--method" "$2")
                            shift 2
                            ;;
                        "--pattern")
                            args+=("--pattern" "$2")
                            shift 2
                            ;;
                        "--dashboard")
                            args+=("--dashboard")
                            shift
                            ;;
                        "--config")
                            args+=("--config" "$2")
                            shift 2
                            ;;
                        *)
                            echo -e "${RED}[!] Unknown option: $1${NC}"
                            show_help
                            exit 1
                            ;;
                    esac
                done
                
                # Ejecutar test
                echo -e "${CYAN}[+] Starting load test...${NC}"
                echo -e "${WHITE}Target: $url${NC}"
                python3 slayer_enterprise_enhanced.py load-test "${args[@]}"
            else
                echo -e "${RED}[!] Error: First argument must be a URL${NC}"
                echo "Usage: $0 <url> [options]"
                show_help
                exit 1
            fi
            ;;
    esac
}

# Ejecutar función principal
main "$@"